# 선착순 쿠폰 발급 시스템

## 1. 문제 정의

선착순 쿠폰 발급은 짧은 시간에 다수의 요청이 동시에 몰리는 특성이 있다.

단순한 CRUD 방식으로 구현할 경우 레이스 컨디션으로 인해 **초과 발급** 또는 **중복 발급**이 발생할 수 있다.

본 프로젝트는 동시성 문제를 재현하고, 정확히 발급 한도만큼만 발급되도록 **데이터 정합성을 보장**하는 것을 목표로 한다.

---

## 2. 데이터 정합성 불변식

본 시스템은 다음 불변식을 항상 만족해야 한다.

1. **발급된 수량 ≤ 발급 한도**
2. **동일 사용자는 동일 캠페인에 대해 1회만 발급 가능**
3. **발급 성공 응답과 영속화된 발급 데이터는 반드시 일치**

---

## 3. 요구사항

### 기능 요구사항

- 쿠폰 캠페인은 **발급 한도**를 가진다.
- 사용자는 하나의 캠페인에 대해 **최대 1회**만 쿠폰을 발급받을 수 있다.
- 발급 한도 소진 시 추가 발급은 불가하다.
- 동일 요청의 재시도 또는 중복 요청에도 **결과는 항상 동일**해야 한다.

### 비기능 요구사항

- 높은 동시 요청 환경에서도 시스템은 **데이터 정합성을 유지**해야 한다.
- 초과 발급 및 중복 발급은 발생하지 않아야 한다.
- 발급 실패 시 실패 원인을 명확히 구분하여 응답해야 한다.

---

## 4. 문제 재현 시나리오

- 발급 한도가 n인 캠페인에 대해 동시에 다수의 발급 요청이 들어오면,  
  동시성 제어가 없을 경우 발급 한도를 초과해 쿠폰이 발급될 수 있다.

- 동일 사용자가 하나의 캠페인에 대해 동시에 여러 요청을 보내면,  
  발급 여부 체크가 원자적이지 않을 경우 중복 발급이 발생할 수 있다.

---

## 5. 설계 제약

- 단일 애플리케이션 인스턴스 기준으로 설계한다.
- 정합성은 MySQL 트랜잭션/제약조건으로 보장한다.
- 멀티 인스턴스, Redis, 큐 기반 구조는 현재 범위에서 제외하며,
  필요 시 확장 가능한 개선 방향으로 둔다.

---

## 6. 설계 선택

- **조건부 UPDATE**(`issued_count < issue_limit`)로 **초과 발급을 방지한다**.
- `(user_id, campaign_id)` **UNIQUE 제약**으로 **중복 발급을 방지한다**.
- 위 두 동작은 하나의 트랜잭션으로 처리한다.

---

## 7. 성공 기준

다음 조건을 모두 만족할 경우 성공으로 정의한다.

- 동시 n(예: 1000) 요청 시 발급 성공 수는 초기 **발급 한도**와 동일하다.
- 동일 사용자에 대한 중복 발급은 발생하지 않는다.
- 발급 한도를 초과한 발급은 발생하지 않는다.
- 실패 응답은 실제 데이터 상태와 일치한다.
